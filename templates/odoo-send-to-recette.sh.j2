#!/bin/bash
set -e

# Configuration
DUMP_DIR="/home/{{ odoo_username }}/.odoo_dumps"
DUMP_FILE="$DUMP_DIR/dump-with-filestore-for-recette.zip"
RECETTE_HOST="oca-france-recette"

# Create dump directory if it doesn't exist
mkdir -p "$DUMP_DIR"

# Perform the dump
echo "Starting Odoo dump..."
{{ working_directory }}/.venv/bin/click-odoo-backupdb --filestore --force -c /home/{{ odoo_username }}/.odoorc {{ database_name }} "$DUMP_FILE"

# Send to recette
echo "Sending dump to recette..."
scp "$DUMP_FILE" "$RECETTE_HOST:$DUMP_FILE"

# Delete local dump on success
echo "Cleanup local dump..."
rm "$DUMP_FILE"

echo "Done!"
