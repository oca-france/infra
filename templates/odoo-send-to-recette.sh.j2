#!/bin/bash
set -e

# Configuration
DUMP_DIR="/home/{{ odoo_username }}/.odoo_dumps"
DUMP_DIRECTORY="$DUMP_DIR/production-data"
RECETTE_HOST="oca-france-recette"

# Create dump directory if it doesn't exist
mkdir -p "$DUMP_DIR"

# Perform the dump
echo "Starting Odoo dump..."
{{ working_directory }}/.venv/bin/click-odoo-backupdb --filestore --force --format folder -c /home/{{ odoo_username }}/.odoorc {{ database_name }} "$DUMP_DIRECTORY"

# Send to recette
echo "Sending dump to recette..."
ssh $RECETTE_HOST "rm -rf $DUMP_DIRECTORY"
scp -r "$DUMP_DIRECTORY" "$RECETTE_HOST:$DUMP_DIRECTORY"

# Delete local dump on success
echo "Cleanup local dump..."
rm -rf "$DUMP_DIRECTORY"

echo "Done!"
